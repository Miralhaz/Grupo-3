<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <title>DASHBOARD | Sensores </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js" defer></script>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body onload="pegarSensores()" id="fundo-sem-scroll">
    <section class="header">
        <div class="header-lateral">
            <div class="barra" onclick="window.location.href='index.html'">
                <span class="material-symbols-outlined">dashboard</span>
                <span style="color: white; font-size: xx-large">Dash</span>
            </div>
            <br>
            <div class="info" onclick="window.location.href='info.html'">
                <span class="material-symbols-outlined">info</span>
                <span style="color: white; font-size: xx-large">Infos</span>
            </div>
            <br>
            <div class="voltar" onclick="window.location.href='../index.html'">
                <span class="material-symbols-outlined">arrow_back</span>
                <span style="color: white; font-size: xx-large">Sair</span>
            </div>
            <div class="caixa-info"></div>
        </div>
    </section>
    <section class="indicadores">
        <div class="container">
            <div class="topo-itens">
                <h1> DashBoard | Sensores da Frota</h1>
                <div class="nome-user">Olá, <span id="usuario_ativo"></span></div>
            </div>
            </h1>
            <div class="all-cards">
                <div class="card">
                    <h3>Status Ativos</h3>
                    <h2 id="total_sensores">36</h2>
                </div>
                <div class="card">
                    <h3>Status Seguro</h3>
                    <h2 id="status_seguro">36</h2>
                </div>
                <div class="card">
                    <h3>Status Alerta</h3>
                    <h2 id="status_alerta">0</h2>
                </div>
                <div class="icone-refresh" onclick="recarregarPagina()">
                    <button style="background-color: transparent; border: none; color: navy; cursor: pointer;"
                        class="material-symbols-outlined" id="btn-recarregar">refresh</button>
                </div>
            </div>
        </div>
    </section>
    <section class="veiculos-all">
        <div class="container">
            <div class="veiculos" id="div_veiculos" onclick="window.location.href='dashboard.html'">
            </div>
        </div>

        <section class="legenda">
            <div class="legenda-veiculos">
                <div class="positivo">
                    <div class="verde"></div>
                    <h1>Adequado</h1>
                </div>
                <div class="negativo">
                    <div class="vermelho"></div>
                    <h1>Verificar</h1>
                </div>
            </div>
        </section>

        </div>
    </section>

</body>
<script>
    let totalSensores = 0;
    function pegarSensores() {
        fetch(`/dados/pegarSensores`)
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                totalSensores = data;
                total_sensores.innerHTML = totalSensores[0].total_sensores;
                console.log(totalSensores[0].total_sensores);
                gerarSensores();
                verificarAlertas();
            })
            .catch(function (err) {
                console.log(err);
            })
    }

    function gerarSensores(){        
        for(let i = 1; i <= totalSensores[0].total_sensores; i++){
            div_veiculos.innerHTML += `<h1 onclick="enviarId(${i})" id="${i}">${i}</h1>`;
        }
    }

    //vou deixar o script aqui pq fica melhor pra arrumar
    function enviarId(sensorId) {
        console.log('Sensor Selecionado:', sensorId);
        sessionStorage.setItem("SENSOR_SELECIONADO", sensorId);
        window.location.href = "dashboard.html";
    }

    //função para verificar alertas existentes e seu status para cada sensor
    let alertas = [];
    let statusSeguro = 0;
    let statusAlerta = 0;
    function verificarAlertas() {
        fetch(`/dados/verificarAlertas`)
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                alertas = data
                console.log(alertas);
                status_seguro.innerHTML = totalSensores[0].total_sensores - alertas.length;
                status_alerta.innerHTML = alertas.length;
                tratarAlertas();
            })
            .catch(function (err) {
                console.log(err);
            })
    }
    function tratarAlertas() {
        for (let i = 0; i < alertas.length; i++) {
            let idSensor = alertas[i].fk_sensor;

            //Vai pegar o h1 respectivo ao fk_sensor que está sendo puxado
            //ou seja, se der fk_sensor = 3, ele vai puxar o h1 de id 3
            let h1Atual = document.getElementById(idSensor);

            h1Atual.style.backgroundColor = '#FF0000AD';
        }
    }

    // Chamar o nome do usuário do login para a página inicial da Dash
    let usuario_ativo = document.getElementById('usuario_ativo')
    var usuarioFormatar = sessionStorage.NOME_USUARIO;
    let nomeDefinitivo = usuarioFormatar.charAt(0).toUpperCase() + usuarioFormatar.slice(1)

    if (sessionStorage.NOME_USUARIO) {
        usuario_ativo.innerHTML = `${nomeDefinitivo} !`
    } else {
        usuario_ativo.innerHTML = 'usuário'
    }

    function recarregarPagina() {
        location.reload()
    }

    setInterval(function () {
        location.reload();
    }, 120000);


</script>

</html>